<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>购销单系统 - 增强版</title>
    <style>
        /* 自动同步状态指示器样式 */
        .sync-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            opacity: 0.7;
        }
        
        .sync-status:hover {
            opacity: 1;
        }
        
        .sync-status.syncing {
            background: #17a2b8;
        }
        
        .sync-status.success {
            background: #28a745;
        }
        
        .sync-status.error {
            background: #dc3545;
        }
        
        .sync-status.offline {
            background: #6c757d;
        }
        
        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .sync-status.syncing .sync-indicator {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* 设备管理面板样式 */
        .device-panel {
            position: fixed;
            top: 0;
            left: -350px;
            width: 350px;
            height: 100vh;
            background: white;
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
            transition: left 0.3s ease;
            z-index: 9999;
            overflow-y: auto;
        }
        
        .device-panel.show {
            left: 0;
        }
        
        .device-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .device-content {
            padding: 20px;
        }
        
        .device-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }
        
        .device-item.current {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        .device-name {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .device-info {
            font-size: 12px;
            color: #6c757d;
        }
        
        .sync-code-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .sync-code {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
            letter-spacing: 2px;
        }
        
        .qr-code {
            margin: 15px 0;
        }
        
        .qr-code canvas {
            border: 2px solid #dee2e6;
            border-radius: 8px;
        }

        /* 用户信息栏样式 */
        .user-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 15px;
            margin: -10px -10px 15px -10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .user-role {
            font-size: 11px;
            opacity: 0.8;
        }
        
        .user-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .user-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            text-decoration: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .user-btn:hover {
            background: rgba(255,255,255,0.3);
            color: white;
        }
        
        .login-prompt {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            margin: -10px -10px 15px -10px;
            text-align: center;
            border-bottom: 1px solid #ffeaa7;
        }
        
        .login-prompt a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            margin: 0 5px;
        }
        
        .login-prompt a:hover {
            text-decoration: underline;
        }
        
        @media screen and (max-width: 768px) {
            .user-bar {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .user-actions {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .user-btn {
                font-size: 11px;
                padding: 5px 10px;
            }
            
            .sync-status {
                position: relative;
                top: auto;
                left: auto;
                margin: 10px auto;
                display: inline-flex;
            }
            
            .device-panel {
                width: 100%;
                left: -100%;
            }
        }
        
        body {
            font-family: "SimSun", "宋体", serif;
            margin: 10px;
            line-height: 1.3;
            color: #000;
            font-size: 12px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
        }
        
        /* 移动端触摸优化 */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }
        
        input, textarea, select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border-radius: 0;
        }
        
        /* 防止移动端缩放 */
        input[type="text"], input[type="number"], input[type="date"] {
            font-size: 12px;
        }
        
        @media screen and (max-width: 768px) {
            input[type="text"], input[type="number"], input[type="date"] {
                font-size: 11px;
            }
        }
        
        .header {
            text-align: center;
            margin-bottom: 12px;
            background: #f8f9fa;
            color: #000000;
            padding: 10px;
            border: 1px solid #000000;
            border-radius: 6px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .header h1 {
            font-family: "Microsoft YaHei", "黑体", "SimHei", sans-serif;
            font-size: 28px;
            font-weight: 900;
            margin: 0;
            color: #000000;
            text-shadow: none;
            letter-spacing: 2px;
        }
        
        .document-type-wrapper {
            position: relative;
            display: inline-block;
            margin-left: 5px;
        }
        
        .document-type-display {
            cursor: pointer;
            font-size: 20px;
            font-weight: 700;
            font-family: "Microsoft YaHei", "黑体", "SimHei", sans-serif;
            color: #000000;
            user-select: none;
            letter-spacing: 1px;
        }
        
        .doc-type-text {
            display: inline;
        }
        
        .dropdown-arrow {
            display: none;
            margin-left: 5px;
            font-size: 16px;
        }
        
        .document-type-display:hover .dropdown-arrow {
            display: inline;
        }
        
        .document-type-display:hover {
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
            padding: 2px 4px;
        }
        
        /* 打印时隐藏同步相关元素和优化打印样式 */
        @media print {
            .dropdown-arrow,
            .document-type-dropdown,
            .sync-status,
            .device-panel,
            .action-buttons,
            .user-bar,
            .login-prompt,
            .file-list-panel {
                display: none !important;
            }
            
            /* 打印优化 */
            body {
                margin: 0 !important;
                padding: 0 !important;
                font-size: 11px !important;
                line-height: 1.2 !important;
            }
            
            .header {
                margin-bottom: 8px !important;
                padding: 8px !important;
            }
            
            .header h1 {
                font-size: 24px !important;
                margin: 0 !important;
            }
            
            .document-type-display {
                font-size: 18px !important;
            }
            
            .notice {
                font-size: 10px !important;
                margin-bottom: 6px !important;
                padding: 6px !important;
            }
            
            table {
                margin-bottom: 6px !important;
                page-break-inside: avoid;
            }
            
            .info-table td {
                height: 22px !important;
                font-size: 10px !important;
                padding: 4px !important;
            }
            
            .product-table th {
                font-size: 11px !important;
                padding: 6px 4px !important;
            }
            
            .product-table td {
                height: 20px !important;
                font-size: 10px !important;
                padding: 3px !important;
            }
            
            .payment-table td {
                height: 20px !important;
                font-size: 10px !important;
                padding: 4px !important;
            }
            
            .terms {
                font-size: 10px !important;
                margin-top: 6px !important;
                padding: 6px !important;
            }
            
            .signature-section {
                margin-top: 6px !important;
            }
            
            .signature-box {
                font-size: 10px !important;
                padding: 6px !important;
            }
            
            .agreement {
                font-size: 9px !important;
                margin-top: 6px !important;
                padding: 6px !important;
            }
            
            /* 去除页眉页脚 */
            @page {
                margin: 0.3in;
                size: A4;
            }
            
            /* 修复标题显示问题 */
            .header h1 {
                white-space: nowrap !important;
                overflow: visible !important;
            }
            
            .document-type-wrapper {
                display: inline !important;
            }
        }
        
        .document-type-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 120px;
            display: none;
        }
        
        .document-type-dropdown.show {
            display: block;
        }
        
        .dropdown-option {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            font-family: "Microsoft YaHei", "黑体", "SimHei", sans-serif;
            color: #333;
        }
        
        .dropdown-option:hover {
            background: #f5f5f5;
        }
        
        .dropdown-option:first-child {
            border-radius: 4px 4px 0 0;
        }
        
        .dropdown-option:last-child {
            border-radius: 0 0 4px 4px;
        }
        
        .header .order-number {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            background: rgba(0,0,0,0.1);
            padding: 8px 15px;
            border-radius: 5px;
            backdrop-filter: blur(10px);
        }
        
        .order-number input {
            background: transparent;
            border: none;
            color: #000000;
            font-size: 16px;
            width: 160px;
            outline: none;
            border-bottom: 2px solid rgba(0,0,0,0.5);
            padding: 5px;
        }
        
        .order-number input::placeholder {
            color: rgba(0,0,0,0.7);
        }
        
        .notice {
            font-size: 12px;
            margin-bottom: 10px;
            padding: 8px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #333;
            border-radius: 4px;
            border-left: 3px solid #6c757d;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .notice strong {
            font-size: 16px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 8px;
            border: 2px solid #000000;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        td, th {
            border: 1px solid #000000;
            padding: 6px;
            text-align: left;
            vertical-align: middle;
        }
        
        .info-table td {
            height: 28px;
            font-size: 12px;
        }
        
        .info-table td:first-child {
            background-color: #f8f9fa;
            font-weight: bold;
            text-align: center;
        }
        
        .product-table th {
            background: #f8f9fa;
            color: #000000;
            text-align: center;
            font-family: "Microsoft YaHei", "黑体", "SimHei", sans-serif;
            font-weight: 900;
            font-size: 14px;
            padding: 12px 8px;
            border: 1px solid #000000;
            letter-spacing: 1px;
        }
        
        .product-table td {
            height: 24px;
            font-size: 12px;
        }
        
        .product-table tfoot td {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .payment-section {
            margin-top: 8px;
        }
        
        .payment-table td {
            height: 26px;
            font-size: 12px;
        }
        
        .payment-table td:first-child {
            background-color: #f8f9fa;
            font-weight: bold;
            text-align: center;
        }
        
        .terms {
            margin-top: 10px;
            font-size: 12px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #6c757d;
        }
        
        .terms strong {
            font-size: 13px;
            color: #333;
        }
        
        .signature-section {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        
        .signature-box {
            flex: 1;
            text-align: center;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .signature-line {
            height: 30px;
            border-bottom: 2px solid #333;
            margin: 8px 0;
        }
        
        .signature-stamp {
            height: 30px;
            border: 2px solid #333;
            margin: 8px 0;
            border-radius: 3px;
        }
        
        .agreement {
            font-size: 11px;
            margin-top: 8px;
            padding: 8px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 4px;
            border-left: 3px solid #6c757d;
        }
        
        .agreement strong {
            font-size: 12px;
            color: #495057;
        }
        
        .input-field {
            width: 100%;
            border: none;
            outline: none;
            background: transparent;
            font-family: inherit;
            font-size: inherit;
            padding: 2px;
        }
        
        .model-input {
            background: #f8f9fa;
            border-radius: 3px;
        }
        
        .delivery-container {
            height: 100%;
            display: flex;
        }
        
        .delivery-label {
            width: 40%;
            background-color: #f8f9fa;
            font-weight: bold;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #333;
        }
        
        .delivery-input {
            width: 60%;
            padding: 12px;
            display: flex;
            align-items: center;
        }
        
        .action-buttons {
            margin: 20px 0;
            text-align: center;
            gap: 15px;
            display: flex;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-print {
            background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(73, 80, 87, 0.4);
        }
        
        .btn-print:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(73, 80, 87, 0.6);
        }
        
        .btn-export {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.4);
        }
        
        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.6);
        }
        
        .btn-image {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }
        
        .btn-image:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
        }
        
        .btn-save-new {
            background: linear-gradient(135deg, #fd7e14 0%, #e63946 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(253, 126, 20, 0.4);
        }
        
        .btn-save-new:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(253, 126, 20, 0.6);
        }
        
        .btn-sync {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-sync:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .amount-container {
            display: flex;
            height: 100%;
        }
        
        .amount-chinese {
            width: 65%;
            padding: 8px 12px;
            border-right: 1px solid #333;
            display: flex;
            align-items: center;
        }
        
        .amount-number {
            width: 35%;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* 文件列表面板样式 */
        .file-list-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .file-list-panel.show {
            right: 0;
        }

        .panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .panel-content {
            padding: 20px;
        }

        .file-stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
        }

        .file-list-content {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .file-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 15px;
            background: white;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .file-header {
            margin-bottom: 8px;
        }
        
        .file-creator {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 4px;
        }
        
        .file-title {
            font-size: 15px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }

        .file-meta {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .file-preview {
            font-size: 13px;
            color: #495057;
            margin-bottom: 10px;
        }

        .file-actions {
            display: flex;
            gap: 8px;
        }

        .file-actions .btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
        }

        .empty-message {
            text-align: center;
            color: #6c757d;
            padding: 40px 20px;
            font-style: italic;
        }
        
        .search-container {
            margin-bottom: 15px;
            display: flex;
            gap: 8px;
        }
        
        .search-input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .search-btn {
            padding: 10px 15px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s ease;
        }
        
        .search-btn:hover {
            background: #5a6268;
        }

        @media (max-width: 768px) {
            .file-list-panel {
                width: 100%;
                right: -100%;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 10px;
                margin: 15px 0;
                padding: 0 5px;
            }
            
            .btn {
                padding: 14px 20px;
                font-size: 16px;
                width: 100%;
                margin: 0;
                border-radius: 8px;
                touch-action: manipulation;
                -webkit-appearance: none;
                cursor: pointer;
            }
        }
    </style>
</head>
<body>
    <!-- 同步状态指示器 -->
    <div id="syncStatus" class="sync-status">
        <div class="sync-indicator"></div>
        <span id="syncStatusText">已连接</span>
    </div>

    <!-- 设备管理面板 -->
    <div id="devicePanel" class="device-panel">
        <div class="device-header">
            <h3>🔄 设备同步</h3>
            <button class="close-btn" onclick="toggleDevicePanel()">✕</button>
        </div>
        <div class="device-content">
            <div class="sync-code-section">
                <h4>📱 同步码</h4>
                <div class="sync-code" id="syncCode">------</div>
                <div class="qr-code" id="qrCode"></div>
                <p style="font-size: 12px; color: #6c757d; margin: 10px 0;">
                    在其他设备上输入此6位数字码即可同步数据
                </p>
                <button class="btn btn-sync" onclick="generateNewSyncCode()" style="margin: 10px 5px; padding: 8px 15px; font-size: 12px;">🔄 生成新码</button>
                <button class="btn btn-sync" onclick="inputSyncCode()" style="margin: 10px 5px; padding: 8px 15px; font-size: 12px;">📥 输入同步码</button>
            </div>
            
            <div class="device-list">
                <h4>📱 已连接设备</h4>
                <div id="deviceList">
                    <div class="device-item current">
                        <div class="device-name">当前设备</div>
                        <div class="device-info">最后同步: 刚刚</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 用户信息栏 -->
    <div id="userBar" class="user-bar" style="display: none;">
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">👤</div>
            <div class="user-details">
                <div class="user-name" id="userName">用户名</div>
                <div class="user-role" id="userRole">角色</div>
            </div>
        </div>
        <div class="user-actions">
            <a href="user-management.html" class="user-btn" id="userManagementBtn" style="display: none;">
                👥 用户管理
            </a>
            <button class="user-btn" onclick="showUserProfile()">
                ⚙️ 个人设置
            </button>
            <button class="user-btn" onclick="logout()">
                🚪 退出登录
            </button>
        </div>
    </div>
    
    <!-- 登录提示栏 -->
    <div id="loginPrompt" class="login-prompt">
        🔐 您当前使用的是访客模式，
        <a href="./login.html">立即登录</a> 或 
        <a href="./register.html">注册账号</a> 
        享受完整功能
    </div>
    
    <div class="action-buttons">
        <button class="btn btn-sync" onclick="toggleDevicePanel()">🔄 设备同步</button>
        <button class="btn btn-save" onclick="saveToCloud()">☁️ 保存到云端</button>
        <button class="btn btn-save-new" onclick="saveAndNew()">💾 保存并新建</button>
        <button class="btn btn-files" onclick="toggleFileList()">📁 文件列表</button>
        <button class="btn btn-manage" onclick="openDataManager()">📊 数据管理</button>
        <button class="btn btn-print" onclick="printForm()">🖨️ 打印表单</button>
        <button class="btn btn-export" onclick="exportToPDF()">📄 导出PDF</button>
        <button class="btn btn-image" onclick="exportToImage()">🖼️ 导出图片</button>
    </div>

    <div class="header">
        <h1>定/销货单(<span class="document-type-wrapper">
            <span class="document-type-display" onclick="toggleDocTypeDropdown()">
                <span class="doc-type-text">预算</span><span class="dropdown-arrow">▼</span>
            </span>
            <div class="document-type-dropdown" id="docTypeDropdown">
                <div class="dropdown-option" onclick="selectDocType('预算')">预算</div>
                <div class="dropdown-option" onclick="selectDocType('结算')">结算</div>
            </div>
        </span>)</h1>
        <div class="order-number">
            单号：<input type="text" placeholder="请输入单号" id="orderNumberInput">
        </div>
    </div>
    
    <div class="notice">
        <strong>温馨提示：</strong>为了购货方的合法权益特制订此政策，请详细阅读本单据购物须知，并确认单据内各项购物内容。一经签字确认，将视同购货方对本单据所有内容均表示同意。
    </div>
    
    <table class="info-table">
        <tr>
            <td style="width: 15%;">购货方</td>
            <td style="width: 35%;"><input type="text" class="input-field"></td>
            <td style="width: 15%;">购货方联系人/电话</td>
            <td style="width: 35%;"><input type="text" class="input-field"></td>
        </tr>
        <tr>
            <td>供货方</td>
            <td><input type="text" class="input-field" value="厦门汇仕环保科技有限公司"></td>
            <td>供货方电话</td>
            <td><input type="text" class="input-field" value="0592-5772750"></td>
        </tr>
        <tr>
            <td>供货方地址</td>
            <td colspan="2"><input type="text" class="input-field" value="厦门市湖里区钟宅红星美凯龙E8038"></td>
            <td rowspan="2" style="padding: 0;">
                <div class="delivery-container">
                    <div class="delivery-label">送货方式</div>
                    <div class="delivery-input">
                        <input type="text" class="input-field" list="deliveryList">
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <td>收货方地址</td>
            <td colspan="2"><input type="text" class="input-field"></td>
        </tr>
        <tr>
            <td>订货日期</td>
            <td><input type="date" class="input-field"></td>
            <td>送货时间</td>
            <td><input type="date" class="input-field"></td>
        </tr>
    </table>
    
    <table class="product-table">
        <thead>
            <tr>
                <th style="width: 22%;">商品名称(品牌+名称)</th>
                <th style="width: 10%;">型号</th>
                <th style="width: 10%;">规格</th>
                <th style="width: 10%;">零售价</th>
                <th style="width: 8%;">数量</th>
                <th style="width: 8%;">单位</th>
                <th style="width: 12%;">合价</th>
            </tr>
        </thead>
        <tbody>
            <tr><td><input type="text" class="input-field" list="productList"></td><td><input type="text" class="input-field model-input" list="modelList"></td><td><input type="text" class="input-field" list="specsList"></td><td><input type="number" class="input-field" step="0.01"></td><td><input type="number" class="input-field"></td><td><input type="text" class="input-field" placeholder="㎡"></td><td><input type="number" class="input-field" step="0.01" readonly></td></tr>
            <tr><td><input type="text" class="input-field" list="productList"></td><td><input type="text" class="input-field model-input" list="modelList"></td><td><input type="text" class="input-field" list="specsList"></td><td><input type="number" class="input-field" step="0.01"></td><td><input type="number" class="input-field"></td><td><input type="text" class="input-field" placeholder="㎡"></td><td><input type="number" class="input-field" step="0.01" readonly></td></tr>
            <tr><td><input type="text" class="input-field" list="productList"></td><td><input type="text" class="input-field model-input" list="modelList"></td><td><input type="text" class="input-field" list="specsList"></td><td><input type="number" class="input-field" step="0.01"></td><td><input type="number" class="input-field"></td><td><input type="text" class="input-field" placeholder="㎡"></td><td><input type="number" class="input-field" step="0.01" readonly></td></tr>
            <tr><td><input type="text" class="input-field" list="productList"></td><td><input type="text" class="input-field model-input" list="modelList"></td><td><input type="text" class="input-field" list="specsList"></td><td><input type="number" class="input-field" step="0.01"></td><td><input type="number" class="input-field"></td><td><input type="text" class="input-field" placeholder="㎡"></td><td><input type="number" class="input-field" step="0.01" readonly></td></tr>
            <tr><td><input type="text" class="input-field" list="productList"></td><td><input type="text" class="input-field model-input" list="modelList"></td><td><input type="text" class="input-field" list="specsList"></td><td><input type="number" class="input-field" step="0.01"></td><td><input type="number" class="input-field"></td><td><input type="text" class="input-field" placeholder="㎡"></td><td><input type="number" class="input-field" step="0.01" readonly></td></tr>
            <tr><td><input type="text" class="input-field" list="productList"></td><td><input type="text" class="input-field model-input" list="modelList"></td><td><input type="text" class="input-field" list="specsList"></td><td><input type="number" class="input-field" step="0.01"></td><td><input type="number" class="input-field"></td><td><input type="text" class="input-field" placeholder="㎡"></td><td><input type="number" class="input-field" step="0.01" readonly></td></tr>
            <tr><td><input type="text" class="input-field" list="productList"></td><td><input type="text" class="input-field model-input" list="modelList"></td><td><input type="text" class="input-field" list="specsList"></td><td><input type="number" class="input-field" step="0.01"></td><td><input type="number" class="input-field"></td><td><input type="text" class="input-field" placeholder="㎡"></td><td><input type="number" class="input-field" step="0.01" readonly></td></tr>
            
    <datalist id="productList">
        <option value="TECH X隔热膜" data-specs="1.52m*30m" data-price="680">
        <option value="隔热膜安装费" data-specs="按面积计算" data-price="25">
        <option value="家居保护膜" data-specs="1.52m*30m" data-price="450">
        <option value="玻璃膜（防紫外防爆）" data-specs="1.52m*30m" data-price="800">
        <option value="安全防爆膜" data-specs="1.52m*30m" data-price="800">
    </datalist>
    <datalist id="modelList">
        <option value="晨曦" data-specs="透光率70%" data-price="799">
        <option value="暮语" data-specs="透光率50%" data-price="799">
        <option value="智幕Pro70" data-specs="透光率70%" data-price="1380">
        <option value="智幕Pro30" data-specs="透光率30%" data-price="1380">
        <option value="维塔VITA" data-specs="透光率80%" data-price="299" data-unit="延米">
        <option value="凌紫" data-specs="透光率60%" data-price="299">
    </datalist>
    <datalist id="specsList">
        <option value="1.52m*30m">
        <option value="1.52m*15m">
        <option value="按面积计算">
        <option value="透光率70%">
        <option value="透光率50%">
        <option value="透光率30%">
        <option value="透光率80%">
        <option value="透光率60%">
        <option value="全车贴膜">
    </datalist>
    <datalist id="paymentList">
        <option value="对私转账">
        <option value="对公转账">
        <option value="微信转账">
        <option value="现金交付">
    </datalist>
    <datalist id="deliveryList">
        <option value="送货上门">
        <option value="自提">
    </datalist>
        </tbody>
        <tfoot>
            <tr style="background-color: #f8f9fa; font-weight: bold;">
                <td colspan="6" style="text-align: right; padding-right: 10px;">合计：</td>
                <td><input type="number" id="totalAmount" class="input-field" step="0.01" readonly style="font-weight: bold; background-color: #f8f9fa;"></td>
            </tr>
        </tfoot>
    </table>
    
    <table>
        <tr>
            <td style="width: 15%; text-align: center; font-weight: bold; background-color: #f8f9fa;">备注</td>
            <td style="height: 50px;"><input type="text" class="input-field" value="质保期五年，从安装结束之日起算；质保期内非人为和自然灾害原因引起的质量问题、安装问题，由供货方负责维保"></td>
        </tr>
    </table>
    
    <div class="payment-section">
        <table class="payment-table">
            <tr>
                <td style="width: 15%;">付款方式</td>
                <td style="width: 85%;"><input type="text" class="input-field" list="paymentList"></td>
            </tr>
            <tr>
                <td>收款账户</td>
                <td style="white-space: nowrap;">账号：<input type="text" class="input-field" style="width: 20%; display: inline-block;" value="6226 1529 0065 3167"> 户名：<input type="text" class="input-field" style="width: 15%; display: inline-block;" value="饶玉珍"> 开户行：<input type="text" class="input-field" style="width: 50%; display: inline-block;" value="中国民生银行"></td>
            </tr>
            <tr>
                <td>实售金额</td>
                <td style="padding: 0;">
                    <div class="amount-container">
                        <div class="amount-chinese">
                            <input type="text" class="input-field chinese-amount" placeholder="大写金额" readonly>
                        </div>
                        <div class="amount-number">
                            小写(¥) <input type="number" class="input-field amount-input" style="width: 60%;" step="0.01">
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td id="paymentLabel">本次付款金额</td>
                <td style="padding: 0;">
                    <div class="amount-container">
                        <div class="amount-chinese">
                            <input type="text" class="input-field chinese-payment" placeholder="大写金额" readonly>
                        </div>
                        <div class="amount-number">
                            小写(¥) <input type="number" class="input-field payment-input" style="width: 60%;" step="0.01">
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td>货款余额</td>
                <td style="padding: 0;">
                    <div class="amount-container">
                        <div class="amount-chinese">
                            <input type="text" class="input-field chinese-balance" placeholder="大写金额" readonly>
                        </div>
                        <div class="amount-number">
                            小写(¥) <input type="number" class="input-field balance-input" style="width: 60%;" step="0.01" readonly>
                        </div>
                    </div>
                </td>
            </tr>
        </table>
    </div>
    
    <div class="terms">
        <strong>其他约定：</strong><br>
        1. 货款余额应由购货方在<input type="text" class="input-field" style="width: 200px; border-bottom: 1px solid #000; display: inline-block;">付清。<br>
        2. 本单实售合计金额中已包含上门检测、测量、设计、出图等相关费用。
    </div>
    
    <div class="signature-section">
        <div class="signature-box">
            <div>供货方签字：</div>
            <div class="signature-line"></div>
        </div>
        <div class="signature-box">
            <div>售后服务章：</div>
            <div class="signature-stamp"></div>
        </div>
        <div class="signature-box">
            <div>购货方签字：</div>
            <div class="signature-line"></div>
        </div>
    </div>
    
    <div class="agreement">
        <strong>购销约定：</strong>1. 如果已付金额小于合计金额的30%，则以已付金额做为交易定金；如果已付金额大于等于合计金额的30%，则以合计金额的30%做为定金。2. 购货方违约退货的，无权要求返回定金；供货方不能交货的，则应返还定金。
    </div>

    <!-- 文件列表面板 -->
    <div id="fileListPanel" class="file-list-panel">
        <div class="panel-header">
            <h3>📁 我的文件列表</h3>
            <button class="close-btn" onclick="toggleFileList()">✕</button>
        </div>
        <div class="panel-content">
            <div class="file-stats">
                <span>总记录数: <strong id="fileCount">0</strong></span>
                <span>最后保存: <strong id="lastSave">从未</strong></span>
            </div>
            
            <!-- 搜索功能 -->
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="搜索创建者或买方..." onkeyup="window.fileManager.searchFiles()">
                <button class="search-btn" onclick="window.fileManager.clearSearch()">清除</button>
                <button class="search-btn cleanup-btn" onclick="window.fileManager.cleanupDuplicates()">🧹 清理重复</button>
            </div>
            
            <div id="fileListContent" class="file-list-content">
                <div class="empty-message">暂无文件</div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <!-- 功能修复补丁 - 保持原有UI不变，只修复功能问题 -->
    <script src="function-fix.js"></script>
    <script>
        // 自动同步系统 - JavaScript代码
        class AutoSyncSystem {
            constructor() {
                this.deviceId = this.getOrCreateDeviceId();
                this.syncCode = null;
                this.isOnline = navigator.onLine;
                this.syncInterval = null;
                this.lastSyncTime = null;
                this.apiToken = localStorage.getItem('github_api_token');
                this.gistId = localStorage.getItem('sync_gist_id');
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.startAutoSync();
                this.generateSyncCode();
                this.loadUserInfo();
                this.initFileManager();
                
                // 延迟更新状态，避免一直显示初始化
                setTimeout(() => {
                    if (this.isOnline) {
                        this.updateSyncStatus('已连接', 'success');
                    } else {
                        this.updateSyncStatus('离线模式', 'offline');
                    }
                }, 1000);
                
                // 监听网络状态变化
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateSyncStatus('已连接网络');
                    this.startAutoSync();
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateSyncStatus('离线模式', 'offline');
                    this.stopAutoSync();
                });
            }

            getOrCreateDeviceId() {
                let deviceId = localStorage.getItem('device_id');
                if (!deviceId) {
                    deviceId = 'device_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('device_id', deviceId);
                }
                return deviceId;
            }

            setupEventListeners() {
                // 监听表单数据变化
                document.addEventListener('input', (e) => {
                    if (e.target.classList.contains('input-field')) {
                        this.scheduleSync();
                    }
                });

                // 监听页面卸载
                window.addEventListener('beforeunload', () => {
                    this.syncToCloud();
                });

                // 定期保存
                setInterval(() => {
                    this.saveToLocal();
                }, 30000); // 每30秒保存一次
            }

            scheduleSync() {
                clearTimeout(this.syncTimeout);
                this.syncTimeout = setTimeout(() => {
                    this.syncToCloud();
                }, 2000); // 2秒后同步
            }

            async generateSyncCode() {
                try {
                    // 生成6位数字同步码
                    this.syncCode = Math.floor(100000 + Math.random() * 900000).toString();
                    document.getElementById('syncCode').textContent = this.syncCode;
                    
                    // 生成二维码
                    await this.generateQRCode();
                    
                    // 保存同步码到云端
                    if (this.isOnline && this.apiToken) {
                        await this.saveSyncCodeToCloud();
                    }
                    
                } catch (error) {
                    console.error('生成同步码失败:', error);
                    this.updateSyncStatus('同步码生成失败', 'error');
                }
            }

            async generateQRCode() {
                try {
                    const qrContainer = document.getElementById('qrCode');
                    qrContainer.innerHTML = '';
                    
                    const canvas = document.createElement('canvas');
                    await QRCode.toCanvas(canvas, this.syncCode, {
                        width: 150,
                        height: 150,
                        margin: 2,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        }
                    });
                    
                    qrContainer.appendChild(canvas);
                } catch (error) {
                    console.error('生成二维码失败:', error);
                    document.getElementById('qrCode').innerHTML = '<p style="color: #dc3545;">二维码生成失败</p>';
                }
            }

            async saveSyncCodeToCloud() {
                if (!this.apiToken) return;

                try {
                    const syncData = {
                        code: this.syncCode,
                        deviceId: this.deviceId,
                        timestamp: Date.now(),
                        data: this.collectFormData()
                    };

                    // 使用同步码作为文件名，确保每个同步码有独立的存储
                    await this.saveToGist(`sync_${this.syncCode}`, syncData);
                    
                    // 同时保存到一个索引文件，方便查找
                    const indexData = {
                        [this.syncCode]: {
                            timestamp: Date.now(),
                            deviceId: this.deviceId,
                            gistId: this.gistId
                        }
                    };
                    
                    // 尝试读取现有索引并合并
                    try {
                        const existingIndex = await this.loadFromGist('sync_index');
                        Object.assign(existingIndex, indexData);
                        await this.saveToGist('sync_index', existingIndex);
                    } catch {
                        // 如果索引不存在，创建新的
                        await this.saveToGist('sync_index', indexData);
                    }
                    
                } catch (error) {
                    console.error('保存同步码到云端失败:', error);
                }
            }

            async saveToGist(filename, data) {
                if (!this.apiToken) {
                    throw new Error('未设置API Token');
                }

                const gistData = {
                    description: "购销单系统数据同步",
                    public: false,
                    files: {
                        [filename + '.json']: {
                            content: JSON.stringify(data, null, 2)
                        }
                    }
                };

                let url = 'https://api.github.com/gists';
                let method = 'POST';

                if (this.gistId) {
                    url = `https://api.github.com/gists/${this.gistId}`;
                    method = 'PATCH';
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `token ${this.apiToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(gistData)
                });

                if (!response.ok) {
                    throw new Error(`GitHub API错误: ${response.status}`);
                }

                const result = await response.json();
                
                if (!this.gistId) {
                    this.gistId = result.id;
                    localStorage.setItem('sync_gist_id', this.gistId);
                }

                return result;
            }

            async loadFromGist(filename) {
                if (!this.apiToken || !this.gistId) {
                    throw new Error('未设置API Token或Gist ID');
                }

                const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                    headers: {
                        'Authorization': `token ${this.apiToken}`,
                    }
                });

                if (!response.ok) {
                    throw new Error(`GitHub API错误: ${response.status}`);
                }

                const gist = await response.json();
                const file = gist.files[filename + '.json'];
                
                if (!file) {
                    throw new Error('文件不存在');
                }

                return JSON.parse(file.content);
            }

            collectFormData() {
                const data = {};
                const inputs = document.querySelectorAll('.input-field');
                
                inputs.forEach((input, index) => {
                    data[`field_${index}`] = input.value;
                });

                // 收集特殊字段
                data.orderNumber = document.getElementById('orderNumberInput')?.value || '';
                data.documentType = document.querySelector('.doc-type-text')?.textContent || '预算';
                data.paymentLabel = document.getElementById('paymentLabel')?.textContent || '本次付款金额';
                data.timestamp = Date.now();
                data.deviceId = this.deviceId;

                return data;
            }

            fillFormData(data) {
                if (!data) return;

                const inputs = document.querySelectorAll('.input-field');
                
                inputs.forEach((input, index) => {
                    if (data[`field_${index}`]) {
                        input.value = data[`field_${index}`];
                    }
                });

                // 填充特殊字段
                if (data.orderNumber && document.getElementById('orderNumberInput')) {
                    document.getElementById('orderNumberInput').value = data.orderNumber;
                }

                if (data.documentType) {
                    const docTypeText = document.querySelector('.doc-type-text');
                    if (docTypeText) {
                        docTypeText.textContent = data.documentType;
                    }
                }
                
                if (data.paymentLabel) {
                    const paymentLabel = document.getElementById('paymentLabel');
                    if (paymentLabel) {
                        paymentLabel.textContent = data.paymentLabel;
                    }
                }

                // 重新计算总金额
                this.calculateTotal();
            }

            async syncToCloud() {
                if (!this.isOnline || !this.apiToken) {
                    this.saveToLocal();
                    return;
                }

                try {
                    this.updateSyncStatus('正在同步...', 'syncing');
                    
                    const formData = this.collectFormData();
                    await this.saveToGist('form_data', formData);
                    
                    this.lastSyncTime = Date.now();
                    localStorage.setItem('last_sync_time', this.lastSyncTime.toString());
                    
                    this.updateSyncStatus('同步成功', 'success');
                    
                    // 3秒后恢复正常状态
                    setTimeout(() => {
                        this.updateSyncStatus('已连接', 'success');
                    }, 3000);
                    
                } catch (error) {
                    console.error('同步失败:', error);
                    this.updateSyncStatus('同步失败', 'error');
                    this.saveToLocal(); // 同步失败时保存到本地
                }
            }

            async loadFromCloud() {
                if (!this.isOnline || !this.apiToken) {
                    this.loadFromLocal();
                    return;
                }

                try {
                    this.updateSyncStatus('正在加载...', 'syncing');
                    
                    const data = await this.loadFromGist('form_data');
                    this.fillFormData(data);
                    
                    this.updateSyncStatus('加载成功', 'success');
                    
                } catch (error) {
                    console.error('加载失败:', error);
                    this.updateSyncStatus('加载失败', 'error');
                    this.loadFromLocal(); // 加载失败时从本地加载
                }
            }

            saveToLocal() {
                try {
                    const formData = this.collectFormData();
                    localStorage.setItem('form_data_backup', JSON.stringify(formData));
                    localStorage.setItem('last_local_save', Date.now().toString());
                } catch (error) {
                    console.error('本地保存失败:', error);
                }
            }

            loadFromLocal() {
                try {
                    const data = localStorage.getItem('form_data_backup');
                    if (data) {
                        this.fillFormData(JSON.parse(data));
                    }
                } catch (error) {
                    console.error('本地加载失败:', error);
                }
            }

            startAutoSync() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                }

                if (this.isOnline && this.apiToken) {
                    this.syncInterval = setInterval(() => {
                        this.syncToCloud();
                    }, 60000); // 每分钟同步一次
                }
            }

            stopAutoSync() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                    this.syncInterval = null;
                }
            }

            updateSyncStatus(text, status = 'default') {
                const statusElement = document.getElementById('syncStatus');
                const textElement = document.getElementById('syncStatusText');
                
                if (statusElement && textElement) {
                    textElement.textContent = text;
                    statusElement.className = `sync-status ${status}`;
                }
            }

            async inputSyncCode() {
                const code = prompt('请输入6位数字同步码:');
                if (!code || code.length !== 6 || !/^\d{6}$/.test(code)) {
                    alert('请输入有效的6位数字同步码');
                    return;
                }

                try {
                    this.updateSyncStatus('正在同步数据...', 'syncing');
                    
                    // 如果没有设置 API Token，提示用户输入
                    if (!this.apiToken) {
                        const token = prompt('请输入GitHub API Token（用于同步功能）:');
                        if (!token) {
                            throw new Error('需要GitHub API Token才能使用同步功能');
                        }
                        this.apiToken = token;
                        localStorage.setItem('github_api_token', token);
                    }
                    
                    // 从云端查找同步码对应的数据
                    const syncData = await this.loadSyncDataByCode(code);
                    if (syncData && syncData.data) {
                        this.fillFormData(syncData.data);
                        this.updateSyncStatus('同步成功', 'success');
                        alert('数据同步成功！');
                        
                        // 保存同步成功的记录
                        localStorage.setItem('last_sync_code', code);
                        localStorage.setItem('last_sync_time', Date.now().toString());
                    } else {
                        throw new Error('未找到对应的同步数据');
                    }
                    
                } catch (error) {
                    console.error('同步失败:', error);
                    this.updateSyncStatus('同步失败', 'error');
                    
                    // 提供更详细的错误信息
                    let errorMessage = '同步失败: ' + error.message;
                    if (error.message.includes('GitHub API错误')) {
                        errorMessage += '

可能的原因：
1. GitHub API Token无效
2. 网络连接问题
3. 同步码已过期';
                    } else if (error.message.includes('未找到')) {
                        errorMessage += '

可能的原因：
1. 同步码输入错误
2. 数据尚未上传到云端
3. 同步码已过期（24小时）';
                    }
                    
                    alert(errorMessage);
                }
            }

            async loadSyncDataByCode(code) {
                try {
                    // 方法1：直接尝试读取对应同步码的文件
                    try {
                        const data = await this.loadFromGist(`sync_${code}`);
                        if (data && data.code === code) {
                            return data;
                        }
                    } catch (error) {
                        console.log('直接读取失败，尝试通过索引查找:', error.message);
                    }
                    
                    // 方法2：通过索引文件查找
                    try {
                        const indexData = await this.loadFromGist('sync_index');
                        if (indexData && indexData[code]) {
                            const syncInfo = indexData[code];
                            
                            // 如果有不同的 gistId，尝试从那个 gist 读取
                            if (syncInfo.gistId && syncInfo.gistId !== this.gistId) {
                                const originalGistId = this.gistId;
                                this.gistId = syncInfo.gistId;
                                
                                try {
                                    const data = await this.loadFromGist(`sync_${code}`);
                                    this.gistId = originalGistId; // 恢复原来的 gistId
                                    
                                    if (data && data.code === code) {
                                        return data;
                                    }
                                } catch (error) {
                                    this.gistId = originalGistId; // 确保恢复
                                    throw error;
                                }
                            }
                        }
                    } catch (error) {
                        console.log('索引查找失败:', error.message);
                    }
                    
                    // 方法3：搜索所有可能的公共 gist（作为备用方案）
                    throw new Error('未找到对应的同步数据，请确认同步码是否正确');
                    
                } catch (error) {
                    throw new Error('无法找到同步数据: ' + error.message);
                }
            }

            calculateTotal() {
                const rows = document.querySelectorAll('.product-table tbody tr');
                let total = 0;

                rows.forEach(row => {
                    const priceInput = row.querySelector('td:nth-child(4) input');
                    const quantityInput = row.querySelector('td:nth-child(5) input');
                    const totalInput = row.querySelector('td:nth-child(7) input');

                    if (priceInput && quantityInput && totalInput) {
                        const price = parseFloat(priceInput.value) || 0;
                        const quantity = parseFloat(quantityInput.value) || 0;
                        const rowTotal = price * quantity;
                        
                        totalInput.value = rowTotal.toFixed(2);
                        total += rowTotal;
                    }
                });

                const totalAmountInput = document.getElementById('totalAmount');
                if (totalAmountInput) {
                    totalAmountInput.value = total.toFixed(2);
                }
                
                // 自动更新实售金额的大写和计算货款余额
                this.updateChineseAmount();
                this.calculateBalance();
            }

            // 数字转中文大写
            numberToChinese(num) {
                const digits = ['零', '壹', '贰', '叁', '肆', '伍', '陆', '柒', '捌', '玖'];
                const units = ['', '拾', '佰', '仟'];
                const bigUnits = ['', '万', '亿'];
                
                if (num === 0) return '零元整';
                
                let numStr = Math.floor(num * 100).toString(); // 转为分
                let result = '';
                
                // 处理整数部分
                let intPart = Math.floor(num);
                if (intPart === 0) {
                    result = '零';
                } else {
                    let intStr = intPart.toString();
                    let len = intStr.length;
                    
                    for (let i = 0; i < len; i++) {
                        let digit = parseInt(intStr[i]);
                        let pos = len - i - 1;
                        
                        if (digit !== 0) {
                            result += digits[digit];
                            if (pos > 0) {
                                if (pos < 4) {
                                    result += units[pos];
                                } else if (pos < 8) {
                                    if (pos === 4) result += '万';
                                    else result += units[pos - 4];
                                } else {
                                    if (pos === 8) result += '亿';
                                    else result += units[pos - 8];
                                }
                            }
                        } else if (i < len - 1 && parseInt(intStr[i + 1]) !== 0) {
                            result += '零';
                        }
                    }
                }
                
                result += '元';
                
                // 处理小数部分
                let decimalPart = Math.round((num - intPart) * 100);
                if (decimalPart === 0) {
                    result += '整';
                } else {
                    let jiao = Math.floor(decimalPart / 10);
                    let fen = decimalPart % 10;
                    
                    if (jiao > 0) {
                        result += digits[jiao] + '角';
                    }
                    if (fen > 0) {
                        result += digits[fen] + '分';
                    }
                }
                
                return result;
            }

            // 更新大写金额
            updateChineseAmount() {
                const totalAmount = parseFloat(document.getElementById('totalAmount')?.value || 0);
                const chineseAmountInput = document.querySelector('.chinese-amount');
                
                if (totalAmount > 0 && chineseAmountInput) {
                    const chineseAmount = this.numberToChinese(totalAmount);
                    chineseAmountInput.value = chineseAmount;
                }
            }

            // 计算货款余额
            calculateBalance() {
                const amountInput = document.querySelector('.amount-input');
                const paymentInput = document.querySelector('.payment-input');
                const balanceInput = document.querySelector('.balance-input');
                const chineseBalanceInput = document.querySelector('.chinese-balance');
                
                const amount = parseFloat(amountInput?.value || 0);
                const payment = parseFloat(paymentInput?.value || 0);
                const balance = amount - payment;
                
                if (balanceInput) {
                    balanceInput.value = balance.toFixed(2);
                }
                
                if (chineseBalanceInput && balance > 0) {
                    chineseBalanceInput.value = this.numberToChinese(balance);
                } else if (chineseBalanceInput) {
                    chineseBalanceInput.value = '';
                }
            }

            // 自动填充产品信息
            autoFillProductInfo(input, type) {
                const value = input.value;
                const row = input.closest('tr');
                
                if (type === 'product') {
                    // 查找产品信息
                    const option = document.querySelector(`#productList option[value="${value}"]`);
                    if (option) {
                        const specs = option.getAttribute('data-specs');
                        const price = option.getAttribute('data-price');
                        const unit = option.getAttribute('data-unit');
                        
                        if (specs) {
                            const specsInput = row.querySelector('td:nth-child(3) input');
                            if (specsInput && !specsInput.value) {
                                specsInput.value = specs;
                            }
                        }
                        
                        if (price) {
                            const priceInput = row.querySelector('td:nth-child(4) input');
                            if (priceInput && !priceInput.value) {
                                priceInput.value = price;
                            }
                        }
                        
                        if (unit) {
                            const unitInput = row.querySelector('td:nth-child(7) input');
                            if (unitInput && !unitInput.value) {
                                unitInput.value = unit;
                            }
                        }
                    }
                } else if (type === 'model') {
                    // 查找型号信息
                    const option = document.querySelector(`#modelList option[value="${value}"]`);
                    if (option) {
                        const specs = option.getAttribute('data-specs');
                        const price = option.getAttribute('data-price');
                        const unit = option.getAttribute('data-unit');
                        
                        if (specs) {
                            const specsInput = row.querySelector('td:nth-child(3) input');
                            if (specsInput && !specsInput.value) {
                                specsInput.value = specs;
                            }
                        }
                        
                        if (price) {
                            const priceInput = row.querySelector('td:nth-child(4) input');
                            if (priceInput && !priceInput.value) {
                                priceInput.value = price;
                            }
                        }
                        
                        if (unit) {
                            const unitInput = row.querySelector('td:nth-child(7) input');
                            if (unitInput && !unitInput.value) {
                                unitInput.value = unit;
                            }
                        }
                    }
                }
                
                // 重新计算总金额
                this.calculateTotal();
            }

            loadUserInfo() {
                try {
                    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                    const userBar = document.getElementById('userBar');
                    const loginPrompt = document.getElementById('loginPrompt');

                    // 更严格的用户信息验证
                    if (userInfo && userInfo.username && userInfo.username.trim() !== '') {
                        // 显示用户信息
                        const userNameElement = document.getElementById('userName');
                        const userRoleElement = document.getElementById('userRole');
                        const userAvatarElement = document.getElementById('userAvatar');
                        
                        if (userNameElement) userNameElement.textContent = userInfo.username;
                        if (userRoleElement) userRoleElement.textContent = userInfo.role || '普通用户';
                        if (userAvatarElement) userAvatarElement.textContent = userInfo.username.charAt(0).toUpperCase();
                        
                        if (userInfo.role === 'admin') {
                            const userManagementBtn = document.getElementById('userManagementBtn');
                            if (userManagementBtn) userManagementBtn.style.display = 'inline-block';
                        }
                        
                        if (userBar) userBar.style.display = 'flex';
                        if (loginPrompt) loginPrompt.style.display = 'none';
                    } else {
                        // 显示访客模式
                        if (userBar) userBar.style.display = 'none';
                        if (loginPrompt) loginPrompt.style.display = 'block';
                    }
                } catch (error) {
                    console.error('加载用户信息失败:', error);
                    // 出错时显示访客模式
                    const userBar = document.getElementById('userBar');
                    const loginPrompt = document.getElementById('loginPrompt');
                    if (userBar) userBar.style.display = 'none';
                    if (loginPrompt) loginPrompt.style.display = 'block';
                }
            }

            initFileManager() {
                window.fileManager = {
                    files: JSON.parse(localStorage.getItem('savedFiles') || '[]'),
                    
                    searchFiles: function() {
                        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                        const filteredFiles = this.files.filter(file => 
                            (file.creator && file.creator.toLowerCase().includes(searchTerm)) ||
                            (file.buyer && file.buyer.toLowerCase().includes(searchTerm))
                        );
                        this.displayFiles(filteredFiles);
                    },
                    
                    clearSearch: function() {
                        document.getElementById('searchInput').value = '';
                        this.displayFiles(this.files);
                    },
                    
                    displayFiles: function(filesToShow = this.files) {
                        const container = document.getElementById('fileListContent');
                        const fileCount = document.getElementById('fileCount');
                        const lastSave = document.getElementById('lastSave');
                        
                        fileCount.textContent = this.files.length;
                        
                        if (this.files.length > 0) {
                            const latest = Math.max(...this.files.map(f => f.timestamp));
                            lastSave.textContent = new Date(latest).toLocaleString();
                        } else {
                            lastSave.textContent = '从未';
                        }
                        
                        if (filesToShow.length === 0) {
                            container.innerHTML = '<div class="empty-message">暂无文件</div>';
                            return;
                        }
                        
                        container.innerHTML = filesToShow.map(file => `
                            <div class="file-item">
                                <div class="file-header">
                                    <div class="file-creator">👤 ${file.creator || '未知用户'}</div>
                                    <div class="file-title">📄 ${file.title || '未命名订单'}</div>
                                </div>
                                <div class="file-meta">
                                    📅 ${new Date(file.timestamp).toLocaleString()} | 
                                    🏢 买方: ${file.buyer || '未填写'} | 
                                    💰 金额: ¥${file.amount || '0.00'}
                                </div>
                                <div class="file-preview">
                                    📝 ${file.preview || '暂无预览'}
                                </div>
                                <div class="file-actions">
                                    <button class="btn btn-load" onclick="window.fileManager.loadFile('${file.id}')">📂 加载</button>
                                    <button class="btn btn-edit" onclick="window.fileManager.editFile('${file.id}')">✏️ 编辑</button>
                                    <button class="btn btn-delete" onclick="window.fileManager.deleteFile('${file.id}')">🗑️ 删除</button>
                                </div>
                            </div>
                        `).join('');
                    },
                    
                    loadFile: function(fileId) {
                        const file = this.files.find(f => f.id === fileId);
                        if (file && file.data) {
                            window.autoSync.fillFormData(file.data);
                            toggleFileList();
                            alert('文件加载成功！');
                        }
                    },
                    
                    editFile: function(fileId) {
                        const file = this.files.find(f => f.id === fileId);
                        if (file && file.data) {
                            // 加载文件数据到表单
                            window.autoSync.fillFormData(file.data);
                            
                            // 关闭文件列表面板
                            toggleFileList();
                            
                            // 显示编辑提示
                            const orderNumber = file.title || '未知订单';
                            const editOptions = [
                                '继续编辑当前订单',
                                '转为结算单据',
                                '另存为新订单'
                            ];
                            
                            const choice = prompt(`正在编辑订单: ${orderNumber}

请选择操作:
1. ${editOptions[0]}
2. ${editOptions[1]}
3. ${editOptions[2]}

请输入数字 1-3:`);
                            
                            if (choice === '2') {
                                // 转为结算
                                selectDocType('结算');
                                alert('已切换为结算模式，请修改相关信息后保存');
                            } else if (choice === '3') {
                                // 另存为新订单，生成新单号
                                const orderInput = document.getElementById('orderNumberInput');
                                if (orderInput) {
                                    orderInput.value = 'GX' + Date.now().toString().slice(-8);
                                }
                                alert('已生成新订单号，请修改后保存为新订单');
                            } else {
                                // 继续编辑当前订单
                                alert('文件已加载，可以继续编辑');
                            }
                        } else {
                            alert('无法加载文件数据');
                        }
                    },
                    
                    deleteFile: function(fileId) {
                        if (confirm('确定要删除这个文件吗？')) {
                            this.files = this.files.filter(f => f.id !== fileId);
                            localStorage.setItem('savedFiles', JSON.stringify(this.files));
                            this.displayFiles();
                        }
                    },
                    
                    cleanupDuplicates: function() {
                        const seen = new Set();
                        const unique = this.files.filter(file => {
                            const key = `${file.creator}_${file.buyer}_${file.amount}`;
                            if (seen.has(key)) {
                                return false;
                            }
                            seen.add(key);
                            return true;
                        });
                        
                        const removed = this.files.length - unique.length;
                        if (removed > 0) {
                            this.files = unique;
                            localStorage.setItem('savedFiles', JSON.stringify(this.files));
                            this.displayFiles();
                            alert(`已清理 ${removed} 个重复文件`);
                        } else {
                            alert('没有发现重复文件');
                        }
                    }
                };
                
                window.fileManager.displayFiles();
            }
        }

        // 全局函数
        function toggleDevicePanel() {
            const panel = document.getElementById('devicePanel');
            panel.classList.toggle('show');
        }

        function generateNewSyncCode() {
            window.autoSync.generateSyncCode();
        }

        function inputSyncCode() {
            window.autoSync.inputSyncCode();
        }

        function saveToCloud() {
            try {
                // 先保存到本地
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                const formData = window.autoSync.collectFormData();
                
                // 获取单号作为标题
                const orderNumber = document.getElementById('orderNumberInput')?.value || 'GX' + Date.now().toString().slice(-8);
                
                // 创建文件记录
                const fileRecord = {
                    id: 'file_' + Date.now(),
                    title: orderNumber, // 使用单号作为标题
                    creator: userInfo.username || '访客用户',
                    buyer: document.querySelector('tr:first-child td:nth-child(2) input')?.value || '未填写',
                    amount: document.getElementById('totalAmount')?.value || '0.00',
                    timestamp: Date.now(),
                    data: formData,
                    preview: `购货方: ${document.querySelector('tr:first-child td:nth-child(2) input')?.value || '未填写'} | 金额: ¥${document.getElementById('totalAmount')?.value || '0.00'}`
                };
                
                // 保存到文件列表
                const savedFiles = JSON.parse(localStorage.getItem('savedFiles') || '[]');
                savedFiles.unshift(fileRecord);
                localStorage.setItem('savedFiles', JSON.stringify(savedFiles));
                
                // 同步到云端
                window.autoSync.syncToCloud();
                
                // 更新文件列表显示
                if (window.fileManager) {
                    window.fileManager.files = savedFiles;
                    window.fileManager.displayFiles();
                }
                
                alert('保存到云端成功！');
            } catch (error) {
                console.error('保存到云端失败:', error);
                alert('保存到云端失败，请检查网络连接');
            }
        }

        function saveAndNew() {
            try {
                // 保存当前数据
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                const formData = window.autoSync.collectFormData();
                
                // 获取单号作为标题
                const orderNumber = document.getElementById('orderNumberInput')?.value || 'GX' + Date.now().toString().slice(-8);
                
                // 创建文件记录
                const fileRecord = {
                    id: 'file_' + Date.now(),
                    title: orderNumber, // 使用单号作为标题
                    creator: userInfo.username || '访客用户',
                    buyer: document.querySelector('tr:first-child td:nth-child(2) input')?.value || '未填写',
                    amount: document.getElementById('totalAmount')?.value || '0.00',
                    timestamp: Date.now(),
                    data: formData,
                    preview: `购货方: ${document.querySelector('tr:first-child td:nth-child(2) input')?.value || '未填写'} | 金额: ¥${document.getElementById('totalAmount')?.value || '0.00'}`
                };
                
                // 保存到文件列表
                const savedFiles = JSON.parse(localStorage.getItem('savedFiles') || '[]');
                savedFiles.unshift(fileRecord);
                localStorage.setItem('savedFiles', JSON.stringify(savedFiles));
                
                // 同步到云端
                window.autoSync.syncToCloud();
                
                // 清空表单但保留预设信息
                document.querySelectorAll('.input-field').forEach(input => {
                    // 保留供货方信息和备注等预设信息
                    if (!input.value.includes('厦门汇仕环保科技有限公司') && 
                        !input.value.includes('0592-5772750') && 
                        !input.value.includes('厦门市湖里区钟宅红星美凯龙E8038') &&
                        !input.value.includes('6226 1529 0065 3167') &&
                        !input.value.includes('饶玉珍') &&
                        !input.value.includes('中国民生银行') &&
                        !input.value.includes('质保期五年')) {
                        input.value = '';
                    }
                });
                
                // 重新生成单号
                const orderInput = document.getElementById('orderNumberInput');
                if (orderInput) {
                    orderInput.value = 'GX' + Date.now().toString().slice(-8);
                }
                
                // 更新文件列表显示
                if (window.fileManager) {
                    window.fileManager.files = savedFiles;
                    window.fileManager.displayFiles();
                }
                
                alert('保存成功！已创建新的空白表单。');
            } catch (error) {
                console.error('保存并新建失败:', error);
                alert('保存失败，请重试');
            }
        }

        function toggleFileList() {
            const panel = document.getElementById('fileListPanel');
            if (panel.classList.contains('show')) {
                panel.classList.remove('show');
            } else {
                panel.classList.add('show');
                window.fileManager.displayFiles();
            }
        }

        function openDataManager() {
            window.open('data-manager.html', '_blank');
        }

        function printForm() {
            // 隐藏不需要打印的元素
            const elementsToHide = document.querySelectorAll('.action-buttons, .sync-status, .device-panel, .file-list-panel, .user-bar, .login-prompt');
            elementsToHide.forEach(el => el.style.display = 'none');
            
            window.print();
            
            // 恢复隐藏的元素
            setTimeout(() => {
                elementsToHide.forEach(el => el.style.display = '');
            }, 1000);
        }

        function exportToPDF() {
            alert('PDF导出功能开发中...');
        }

        function exportToImage() {
            const elementsToHide = document.querySelectorAll('.action-buttons, .sync-status, .device-panel, .file-list-panel, .user-bar, .login-prompt');
            elementsToHide.forEach(el => el.style.display = 'none');
            
            html2canvas(document.body, {
                scale: 2,
                useCORS: true,
                allowTaint: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `购销单_${new Date().toLocaleDateString()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                
                // 恢复隐藏的元素
                elementsToHide.forEach(el => el.style.display = '');
            }).catch(error => {
                console.error('导出图片失败:', error);
                alert('导出图片失败，请重试');
                elementsToHide.forEach(el => el.style.display = '');
            });
        }

        function toggleDocTypeDropdown() {
            const dropdown = document.getElementById('docTypeDropdown');
            dropdown.classList.toggle('show');
        }

        function selectDocType(type) {
            document.querySelector('.doc-type-text').textContent = type;
            document.getElementById('docTypeDropdown').classList.remove('show');
            
            // 更新单号后缀
            const orderInput = document.getElementById('orderNumberInput');
            if (orderInput) {
                let orderNumber = orderInput.value;
                if (type === '结算') {
                    // 如果是结算，在单号后加"结"字
                    if (!orderNumber.endsWith('结')) {
                        orderNumber = orderNumber.replace(/结$/, '') + '结';
                    }
                    // 更新付款标签
                    document.getElementById('paymentLabel').textContent = '已付款金额';
                } else {
                    // 如果是预算，移除"结"字
                    orderNumber = orderNumber.replace(/结$/, '');
                    // 更新付款标签
                    document.getElementById('paymentLabel').textContent = '本次付款金额';
                }
                orderInput.value = orderNumber;
            }
        }

        function showUserProfile() {
            alert('个人设置功能开发中...');
        }

        function logout() {
            if (confirm('确定要退出登录吗？')) {
                localStorage.removeItem('userInfo');
                localStorage.removeItem('github_api_token');
                location.reload();
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化自动同步系统
            window.autoSync = new AutoSyncSystem();
            
            // 设置表单计算和产品信息自动填充
            document.addEventListener('input', function(e) {
                if (e.target.matches('.product-table input[type="number"]')) {
                    window.autoSync.calculateTotal();
                }
                
                // 产品名称自动填充
                if (e.target.matches('.product-table td:first-child input')) {
                    window.autoSync.autoFillProductInfo(e.target, 'product');
                }
                
                // 型号自动填充
                if (e.target.matches('.product-table td:nth-child(2) input')) {
                    window.autoSync.autoFillProductInfo(e.target, 'model');
                }
                
                // 金额输入时自动转换大写和计算余额
                if (e.target.matches('.amount-input')) {
                    const amount = parseFloat(e.target.value) || 0;
                    const chineseInput = document.querySelector('.chinese-amount');
                    if (chineseInput && amount > 0) {
                        chineseInput.value = window.autoSync.numberToChinese(amount);
                    }
                    window.autoSync.calculateBalance();
                }
                
                if (e.target.matches('.payment-input')) {
                    const payment = parseFloat(e.target.value) || 0;
                    const chineseInput = document.querySelector('.chinese-payment');
                    if (chineseInput && payment > 0) {
                        chineseInput.value = window.autoSync.numberToChinese(payment);
                    }
                    window.autoSync.calculateBalance();
                }
            });
            
            // 点击外部关闭下拉菜单
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.document-type-wrapper')) {
                    document.getElementById('docTypeDropdown').classList.remove('show');
                }
                
                if (!e.target.closest('.device-panel') && !e.target.matches('.btn-sync')) {
                    document.getElementById('devicePanel').classList.remove('show');
                }
            });
            
            // 初始化单号
            const orderInput = document.getElementById('orderNumberInput');
            if (orderInput && !orderInput.value) {
                orderInput.value = 'GX' + Date.now().toString().slice(-8);
            }
            
            // 加载保存的数据
            window.autoSync.loadFromCloud();
        });
    </script>
    
    <!-- Bug修复补丁 -->
    <script src="bug-fix-patch.js"></script>
</body>
</html>